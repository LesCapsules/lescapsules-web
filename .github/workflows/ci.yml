name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        linter:
          - eslint
          - prettier
          - tsc

    steps:
      - uses: actions/checkout@v2

      # Read node version from `.nvmrc` file
      - id: nvmrc
        uses: browniebroke/read-nvmrc-action@v1

      - uses: actions/setup-node@v2
        with:
          node-version: '${{ steps.nvmrc.outputs.node_version }}'

      - run: yarn
      - run: |
          yarn lint:${{ matrix.linter }}

  bundlewatch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      # Read node version from `.nvmrc` file
      - id: nvmrc
        uses: browniebroke/read-nvmrc-action@v1

      - uses: actions/setup-node@v2
        with:
          node-version: '${{ steps.nvmrc.outputs.node_version }}'

      - run: yarn
      - run: yarn bundlewatch
        env:
          BUNDLEWATCH_GITHUB_TOKEN: ${{ secrets.BUNDLEWATCH_GITHUB_TOKEN }}

  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      # PR: check deploy preview
      - name: Wait for the Netlify Preview
        if: ${{ github.event_name == 'pull_request' }}
        uses: jakepartusch/wait-for-netlify-action@v1
        id: netlify
        with:
          site_name: 'lescapsules'
          max_timeout: 360
      - name: Audit URLs using Lighthouse
        if: ${{ github.event_name == 'pull_request' }}
        uses: treosh/lighthouse-ci-action@v7
        with:
          urls: |
            ${{ steps.netlify.outputs.url }}
            ${{ steps.netlify.outputs.url }}/drink-team/
            ${{ steps.netlify.outputs.url }}/photos/
            ${{ steps.netlify.outputs.url }}/videos/
          # budgetPath: ./budget.json
          # configPath: ./lighthouserc.json
          uploadArtifacts: true
          serverBaseUrl: ${{ secrets.LHCI_SERVER_URL }}
          serverToken: ${{ secrets.LHCI_SERVER_TOKEN }}

      # Push: check production
      - name: Wait for prod deploy
        if: ${{ github.event_name == 'push' }}
        run: sleep 360 # 6 mins in seconds
      - name: Audit URLs using Lighthouse
        if: ${{ github.event_name == 'push' }}
        uses: treosh/lighthouse-ci-action@v7
        with:
          urls: |
            https://www.lescapsules.com
            https://www.lescapsules.com/drink-team/
            https://www.lescapsules.com/photos/
            https://www.lescapsules.com/videos/
          # budgetPath: ./budget.json
          # configPath: ./lighthouserc.json
          uploadArtifacts: true
          serverBaseUrl: ${{ secrets.LHCI_SERVER_URL }}
          serverToken: ${{ secrets.LHCI_SERVER_TOKEN }}
